; manual toolchange with automatic pneumatic 3d probe interaction
; http://linuxcnc.org/docs/html/gcode/overview.html#gcode:predefined-named-parameters

o<manual_tool_change> sub

M65 P#<_ini[3DPROBE]PNEUMATIC_PIN> ; moves back in the 3d probe

o10 if [#<selected_tool> EQ #<tool_in_spindle>]
    (msg, selected tool already in spindle.)
    o<manual_tool_change> endsub[1]
    M2
o10 endif

o11 if [#<spindle_on> EQ 1]
    M5
o11 endif

o12 if [[#<_mist> EQ 1] OR [#<_flood> EQ 1]]
    M9
o12 endif

O220 IF [#<selected_tool> EQ #<_ini[3DPROBE]TOOLTABLE_NUMBER>]
  M64 P#<_ini[3DPROBE]PNEUMATIC_PIN> ; activate, moves out the 3d probe 
O220 ENDIF

o<manual_tool_change> endsub [1]
M2